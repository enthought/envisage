<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>envisage.plugins.ipython_kernel.kernelapp &mdash; Envisage Documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../../../../_static/enthought.css" type="text/css" >
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" >
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '4.9.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../../_static/js/copybutton.js"></script>
    <script type="text/javascript" src="../../../../_static/js/wrap_on_dot.js"></script>
    <link rel="shortcut icon" href="../../../../_static/img/favicon.ico">
    <link rel="index" title="Index" href="../../../../genindex.html" >
    <link rel="search" title="Search" href="../../../../search.html" >
    <link rel="top" title="Envisage Documentation" href="../../../../index.html" >
    <link rel="up" title="Module code" href="../../../index.html" > 
  </head>
  <body>
  <div class="container">
    <div class="header">
    </div>
  </div>

    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
	
        <li class="active"><a href="../../../../index.html">Envisage Documentation</a></li>
	
          <li class="active"><a href="../../../index.html" accesskey="U">Module code</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../../../../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../../../../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  <h1>Source code for envisage.plugins.ipython_kernel.kernelapp</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains an extended version of the upstream ipykernel IPKernelApp.</span>

<span class="sd">The main reason for extending is to support clean shutdown.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">ipykernel.ipkernel</span>
<span class="kn">import</span> <span class="nn">ipykernel.kernelapp</span>
<span class="kn">import</span> <span class="nn">ipykernel.zmqshell</span>
<span class="kn">import</span> <span class="nn">IPython.utils.io</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">zmq</span>

<span class="kn">from</span> <span class="nn">envisage.plugins.ipython_kernel.heartbeat</span> <span class="k">import</span> <span class="n">Heartbeat</span>


<span class="c1"># The IPython machinery registers various atexit cleanup handlers. We</span>
<span class="c1"># need to be able to do cleanup *before* process exit time, and some</span>
<span class="c1"># of the registered handlers are not idempotent, and so cause errors</span>
<span class="c1"># at process exit time. Those handlers also interfere with timely garbage</span>
<span class="c1"># collection by holding onto references to otherwise dead objects. So we</span>
<span class="c1"># deliberately unregister all registered handlers.</span>

<span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY2</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">atexit_unregister</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="c1"># Replace the contents, not the list itself, in case anyone else</span>
        <span class="c1"># is keeping references to it. Also use &#39;not thing == func&#39; instead</span>
        <span class="c1"># of &#39;thing != func&#39; to match the semantics of the Python 3 code.</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">_exithandlers</span><span class="p">[:]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">handler</span> <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">atexit</span><span class="o">.</span><span class="n">_exithandlers</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">handler</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">func</span>
        <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">atexit</span> <span class="k">import</span> <span class="n">unregister</span> <span class="k">as</span> <span class="n">atexit_unregister</span>

<span class="c1"># Sentinel object used to represent a missing attribute.</span>
<span class="n">_MISSING</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>


<div class="viewcode-block" id="IPKernelApp"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp">[docs]</a><span class="k">class</span> <span class="nc">IPKernelApp</span><span class="p">(</span><span class="n">ipykernel</span><span class="o">.</span><span class="n">kernelapp</span><span class="o">.</span><span class="n">IPKernelApp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Patched version of the IPKernelApp, mostly to support clean shutdown.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Methods overridden from the base class ##################################</span>

<div class="viewcode-block" id="IPKernelApp.init_heartbeat"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.init_heartbeat">[docs]</a>    <span class="k">def</span> <span class="nf">init_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;start the heart beating</span>

<span class="sd">        Overridden from the base class in order to swap in our own</span>
<span class="sd">        Heartbeat class in place of the official one. Our Heartbeat class</span>
<span class="sd">        is modified to allow the heartbeat thread to be shut down cleanly.</span>

<span class="sd">        This override can be removed once we&#39;re on ipkernel 5.x.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># heartbeat doesn&#39;t share context, because it mustn&#39;t be blocked</span>
        <span class="c1"># by the GIL, which is accessed by libzmq when freeing zero-copy</span>
        <span class="c1"># messages</span>
        <span class="n">hb_ctx</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat</span> <span class="o">=</span> <span class="n">Heartbeat</span><span class="p">(</span>
            <span class="n">hb_ctx</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hb_port</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hb_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat</span><span class="o">.</span><span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Heartbeat REP Channel on port: </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hb_port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPKernelApp.patch_io"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.patch_io">[docs]</a>    <span class="k">def</span> <span class="nf">patch_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Patch important libraries that can&#39;t handle sys.stdout forwarding.</span>

<span class="sd">        Overridden from the base class to do nothing.</span>

<span class="sd">        The base class method monkeypatches faulthandler so that calling</span>
<span class="sd">        faulthandler.enable() while streams are redirected doesn&#39;t fail.</span>

<span class="sd">        This override bypasses that patching. Users of the Envisage plugin</span>
<span class="sd">        are advised to enable faulthandler (if desired) as part of</span>
<span class="sd">        application setup, before the plugin is started.</span>

<span class="sd">        Related: https://github.com/ipython/ipykernel/issues/91</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="IPKernelApp.configure_tornado_logger"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.configure_tornado_logger">[docs]</a>    <span class="k">def</span> <span class="nf">configure_tornado_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure tornado logging.</span>

<span class="sd">        Adds a NullHandler to the tornado root logger, if there are</span>
<span class="sd">        no handlers already present on that logger. If no tornado</span>
<span class="sd">        handler is present at the time the IO loop is started, tornado</span>
<span class="sd">        will call logging.basicConfig, which isn&#39;t what we want to happen.</span>

<span class="sd">        Overridden from the base class, which unconditionally adds a new</span>
<span class="sd">        StreamHandler every time.</span>

<span class="sd">        See also:</span>
<span class="sd">        - https://github.com/tornadoweb/tornado/blob/v6.0.3/tornado/ioloop.py#L427-L445  # noqa: E501</span>
<span class="sd">        - https://github.com/tornadoweb/tornado/pull/741</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;tornado&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NullHandler</span><span class="p">())</span></div>

<div class="viewcode-block" id="IPKernelApp.log_connection_info"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.log_connection_info">[docs]</a>    <span class="k">def</span> <span class="nf">log_connection_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display connection info, and store ports.</span>

<span class="sd">        Overridden to not write information to __stdout__. We don&#39;t usually</span>
<span class="sd">        want this in applications that embed an IPython kernel (as opposed</span>
<span class="sd">        to the case where IPython effectively *is* the application).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">basename</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_file</span> <span class="ow">or</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_file</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_dir</span><span class="p">):</span>
            <span class="c1"># use shortname</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="n">basename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_file</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;To connect another client to this kernel, use:&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    --existing </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tail</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># log connection info</span>
        <span class="c1"># info-level, so often not shown.</span>
        <span class="c1"># frontends should use the %connect_info magic</span>
        <span class="c1"># to see the connection info</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ports</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">shell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shell_port</span><span class="p">,</span>
            <span class="n">iopub</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iopub_port</span><span class="p">,</span>
            <span class="n">stdin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stdin_port</span><span class="p">,</span>
            <span class="n">hb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hb_port</span><span class="p">,</span>
            <span class="n">control</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">control_port</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="c1"># Methods extending the base class methods ################################</span>

<div class="viewcode-block" id="IPKernelApp.init_crash_handler"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.init_crash_handler">[docs]</a>    <span class="k">def</span> <span class="nf">init_crash_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up a suitable exception hook.</span>

<span class="sd">        Extended to keep track of the original sys.excepthook value, so that it</span>
<span class="sd">        can be restored later.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_sys_excepthook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IPKernelApp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">init_crash_handler</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPKernelApp.init_io"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.init_io">[docs]</a>    <span class="k">def</span> <span class="nf">init_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redirect input streams and set a display hook.</span>

<span class="sd">        Extended to store the original sys attributes so that they</span>
<span class="sd">        can be restored later.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outstream_class</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_sys_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_sys_stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayhook_class</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_sys_displayhook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">displayhook</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">IPKernelApp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">init_io</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPKernelApp.init_kernel"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.init_kernel">[docs]</a>    <span class="k">def</span> <span class="nf">init_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the kernel object itself.</span>

<span class="sd">        Extended to store the original values of IPython.utils.io.stdout</span>
<span class="sd">        and IPython.utils.io.stderr, so that they can be restored later.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_ipython_utils_io_stdout</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">IPython</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">io</span><span class="p">,</span> <span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="n">_MISSING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_ipython_utils_io_stderr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">IPython</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">io</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">,</span> <span class="n">_MISSING</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IPKernelApp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">init_kernel</span><span class="p">()</span></div>

    <span class="c1"># New methods, mostly to control shutdown #################################</span>

<div class="viewcode-block" id="IPKernelApp.close"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Undo the effects of the initialize method:</span>

<span class="sd">        - free resources allocated during initialization</span>
<span class="sd">        - undo changes to global state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: the upstream ipykernel introduced its own close method in</span>
        <span class="c1"># v5.1.2, along with an atexit handler for that method. See</span>
        <span class="c1"># https://github.com/ipython/ipykernel/pull/412. For ipykernel versions</span>
        <span class="c1"># of 5.1.2 or later, this method overrides the base class version.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_shell</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_kernel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_io</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_heartbeat</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_sockets</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_connection_file</span><span class="p">()</span>
        <span class="n">atexit_unregister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup_connection_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_crash_handler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_profile_dir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_singletons</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPKernelApp.close_shell"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.close_shell">[docs]</a>    <span class="k">def</span> <span class="nf">close_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean up resources allocated by the shell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">shell</span>

        <span class="c1"># Clean up script magics object, which is contained in a reference</span>
        <span class="c1"># cycle, and has a __del__ method, preventing its removal in Python 2.</span>
        <span class="n">magics_manager</span> <span class="o">=</span> <span class="n">shell</span><span class="o">.</span><span class="n">magics_manager</span>
        <span class="n">script_magics</span> <span class="o">=</span> <span class="n">magics_manager</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s2">&quot;ScriptMagics&quot;</span><span class="p">]</span>
        <span class="n">script_magics</span><span class="o">.</span><span class="n">kill_bg_processes</span><span class="p">()</span>
        <span class="n">atexit_unregister</span><span class="p">(</span><span class="n">script_magics</span><span class="o">.</span><span class="n">kill_bg_processes</span><span class="p">)</span>
        <span class="n">script_magics</span><span class="o">.</span><span class="n">magics</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">script_magics</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">script_magics</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># The shell&#39;s cleanup method restores the sys.module changes.</span>
        <span class="n">shell</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

        <span class="c1"># The atexit_operations method ends the history manager session,</span>
        <span class="c1"># but doesn&#39;t stop the history manager&#39;s save_thread, so we need</span>
        <span class="c1"># to do that separately.</span>
        <span class="n">shell</span><span class="o">.</span><span class="n">atexit_operations</span><span class="p">()</span>
        <span class="n">atexit_unregister</span><span class="p">(</span><span class="n">shell</span><span class="o">.</span><span class="n">atexit_operations</span><span class="p">)</span>

        <span class="n">shell</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">save_thread</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">atexit_unregister</span><span class="p">(</span><span class="n">shell</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">save_thread</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>

        <span class="c1"># Rely on garbage collection to clean up the file connection.</span>
        <span class="n">shell</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Remove some references to avoid keeping objects alive unnecessarily.</span>
        <span class="k">del</span> <span class="n">shell</span><span class="o">.</span><span class="n">configurables</span><span class="p">[:]</span>
        <span class="k">del</span> <span class="n">shell</span><span class="o">.</span><span class="n">sys_excepthook</span>
        <span class="k">del</span> <span class="n">shell</span><span class="o">.</span><span class="n">_orig_sys_module_state</span>
        <span class="k">del</span> <span class="n">shell</span><span class="o">.</span><span class="n">_orig_sys_modules_main_mod</span></div>

<div class="viewcode-block" id="IPKernelApp.close_kernel"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.close_kernel">[docs]</a>    <span class="k">def</span> <span class="nf">close_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Undo setup from init_kernel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Unhook listeners, and close kernel streams (which also closes</span>
        <span class="c1"># the corresponding zmq.Socket objects).</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span>
        <span class="k">while</span> <span class="n">kernel</span><span class="o">.</span><span class="n">shell_streams</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">shell_streams</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">stop_on_recv</span><span class="p">()</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Remove selected references to allow effective garbage collection.</span>
        <span class="n">kernel</span><span class="o">.</span><span class="n">stdin_socket</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Undo changes to IPython.utils.io made at shell creation time.</span>
        <span class="c1"># The values written by the shell keep references that prevent</span>
        <span class="c1"># proper garbage collection from taking place.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_ipython_utils_io_stderr</span> <span class="ow">is</span> <span class="n">_MISSING</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">IPython</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">stderr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">IPython</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_ipython_utils_io_stderr</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_ipython_utils_io_stderr</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_ipython_utils_io_stdout</span> <span class="ow">is</span> <span class="n">_MISSING</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">IPython</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">IPython</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_ipython_utils_io_stdout</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_ipython_utils_io_stdout</span></div>

<div class="viewcode-block" id="IPKernelApp.close_io"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.close_io">[docs]</a>    <span class="k">def</span> <span class="nf">close_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Undo the effects of init_io.</span>

<span class="sd">        Restores sys module attributes altered by init_io.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayhook_class</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">displayhook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_sys_displayhook</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_sys_displayhook</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outstream_class</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_sys_stderr</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_sys_stderr</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_sys_stdout</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_sys_stdout</span></div>

<div class="viewcode-block" id="IPKernelApp.close_iopub"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.close_iopub">[docs]</a>    <span class="k">def</span> <span class="nf">close_iopub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close iopub-related resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iopub_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iopub_thread</span><span class="o">.</span><span class="n">socket</span>

        <span class="c1"># Remove the atexit handler that&#39;s registered.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iopub_thread</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">atexit_unregister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iopub_thread</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>

        <span class="n">iopub_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPKernelApp.close_crash_handler"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.close_crash_handler">[docs]</a>    <span class="k">def</span> <span class="nf">close_crash_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Undo the global state change from init_crash_handler.</span>

<span class="sd">        Restore the sys.excepthook attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_sys_excepthook</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_sys_excepthook</span></div>

<div class="viewcode-block" id="IPKernelApp.close_heartbeat"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.close_heartbeat">[docs]</a>    <span class="k">def</span> <span class="nf">close_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the heartbeat thread, by terminating the corresponding</span>
<span class="sd">        zmq.Context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This should interrupt the zmq.device call.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">term</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>

<div class="viewcode-block" id="IPKernelApp.close_sockets"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.close_sockets">[docs]</a>    <span class="k">def</span> <span class="nf">close_sockets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unbind, close and destroy sockets created by init_sockets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_iopub</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;shell&#39;</span><span class="p">,</span> <span class="s1">&#39;control&#39;</span><span class="p">,</span> <span class="s1">&#39;stdin&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closing </span><span class="si">%s</span><span class="s2"> channel&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
            <span class="n">socket</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span> <span class="o">+</span> <span class="s2">&quot;_socket&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">socket</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">socket</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># ipykernel 5.1.2 and later creates its own context. Earlier versions</span>
        <span class="c1"># use the shared zmq context. Ref: ipython/ipykernel#412.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;context&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Terminating zmq context&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">term</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Terminated zmq context&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IPKernelApp.close_profile_dir"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.close_profile_dir">[docs]</a>    <span class="k">def</span> <span class="nf">close_profile_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Undo changes made in init_profile_dir.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ipython_dir_entry</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ipython_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ipython_dir_entry</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ipython_dir_entry</span><span class="p">)</span></div>

<div class="viewcode-block" id="IPKernelApp.cleanup_singletons"><a class="viewcode-back" href="../../../../api/envisage.plugins.ipython_kernel.html#envisage.plugins.ipython_kernel.kernelapp.IPKernelApp.cleanup_singletons">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup_singletons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear SingletonConfigurable instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># These instances will otherwise hinder garbage collection,</span>
        <span class="c1"># and prevent a clean recreation of a new kernel app.</span>
        <span class="n">ipykernel</span><span class="o">.</span><span class="n">zmqshell</span><span class="o">.</span><span class="n">ZMQInteractiveShell</span><span class="o">.</span><span class="n">clear_instance</span><span class="p">()</span>
        <span class="n">ipykernel</span><span class="o">.</span><span class="n">ipkernel</span><span class="o">.</span><span class="n">IPythonKernel</span><span class="o">.</span><span class="n">clear_instance</span><span class="p">()</span></div></div>
</pre></div>

          </div>
        </div>
          </div>
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/img/e-logo.png" alt="Logo">
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2008-2019, Enthought
      </li>
      <li>
      Last updated on Feb 14, 2020.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 2.3.1.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>